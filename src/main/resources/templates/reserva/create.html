<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layouts/_mainLayout">

<div layout:fragment="content" class="flex flex-1 justify-center py-10 px-4 sm:px-6 lg:px-8">

  <div class="max-w-md w-full space-y-6">
    <h2 class="text-center text-2xl font-bold">Crear Reserva</h2>

    <form th:action="@{/reservas/save}" th:object="${reserva}" method="post" class="mt-8 space-y-6">

      <!-- Precio por noche (oculto, con protecci칩n null) -->
      <input type="hidden" id="precio" th:value="${tipoHabitacionActual != null} ? ${tipoHabitacionActual.costo} : 0">

      <!-- Usuario -->
      <div>
        <label for="idUsuario" class="block text-sm font-medium">Usuario</label>
        <input type="hidden" th:field="*{idUsuario}" />
        <span th:text="${usuarioActual != null} ? ${usuarioActual.nombre} : 'No disponible'"
              class="mt-1 block w-full border rounded-md p-2 bg-gray-100"></span>
        <p th:if="${#fields.hasErrors('idUsuario')}"
           th:errors="*{idUsuario}"
           class="text-red-500 text-sm"></p>
      </div>

      <!-- Hotel -->
      <div>
        <label for="idHotel" class="block text-sm font-medium">Hotel</label>
        <input type="hidden" th:field="*{idHotel}" />
        <span th:text="${hotelActual != null} ? ${hotelActual.nombre} : 'No disponible'" class="mt-1 block w-full border rounded-md p-2 bg-gray-100"></span>
        <p th:if="${#fields.hasErrors('idHotel')}" th:errors="*{idHotel}" class="text-red-500 text-sm"></p>
      </div>

      <!-- Tipo de habitaci칩n -->
      <div>
        <label for="idTipoHabitacion" class="block text-sm font-medium">Tipo de habitaci칩n</label>
        <input type="hidden" th:field="*{idTipoHabitacion}" />
        <span th:text="${tipoHabitacionActual != null} ? ${tipoHabitacionActual.nombre} : 'No disponible'"
              class="mt-1 block w-full border rounded-md p-2 bg-gray-100"></span>
        <p th:if="${#fields.hasErrors('idTipoHabitacion')}"
           th:errors="*{idTipoHabitacion}"
           class="text-red-500 text-sm"></p>
      </div>

      <!-- Fecha realizado (solo lectura como texto) -->
      <div>
        <label for="fechaRealizado" class="block text-sm font-medium">Fecha realizado</label>
        <input type="hidden" th:field="*{fechaRealizado}" id="fechaRealizado"/>
        <span id="fechaRealizadoTexto"
              class="mt-1 block w-full border rounded-md p-2 bg-gray-100"></span>
        <p th:if="${#fields.hasErrors('fechaRealizado')}" th:errors="*{fechaRealizado}" class="text-red-500 text-sm"></p>
      </div>

      <!-- Fecha inicio -->
      <div>
        <label for="fechaInicio" class="block text-sm font-medium">Fecha inicio</label>
        <input type="datetime-local" th:field="*{fechaInicio}" id="fechaInicio"
               class="mt-1 block w-full border rounded-md p-2"/>
        <p th:if="${#fields.hasErrors('fechaInicio')}" th:errors="*{fechaInicio}" class="text-red-500 text-sm"></p>
      </div>

      <!-- Fecha fin -->
      <div>
        <label for="fechaFin" class="block text-sm font-medium">Fecha fin</label>
        <input type="datetime-local" th:field="*{fechaFin}" id="fechaFin"
               class="mt-1 block w-full border rounded-md p-2"/>
        <p th:if="${#fields.hasErrors('fechaFin')}" th:errors="*{fechaFin}" class="text-red-500 text-sm"></p>
      </div>

      <!-- Total -->
      <div>
        <label for="total" class="block text-sm font-medium">Total</label>
        <input type="number" step="0.01" th:field="*{total}" id="total" placeholder="Total"
               class="mt-1 block w-full border rounded-md p-2" readonly/>
        <p th:if="${#fields.hasErrors('total')}" th:errors="*{total}" class="text-red-500 text-sm"></p>
      </div>

      <!-- Botones -->
      <div class="flex flex-col sm:flex-row-reverse gap-4 pt-4">
        <button type="submit"
                class="flex w-full justify-center rounded-full border border-transparent
                   bg-[var(--primary-color)] py-3 px-4 text-sm font-bold text-white
                   shadow-sm hover:bg-green-600 transition-colors focus:outline-none
                   focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
          Crear
        </button>

        <a th:href="@{/reservas/detallehotel/{id}(id=${reserva.idHotel})}"
           class="flex w-full justify-center rounded-full border border-secondary-100
              bg-gray-100 text-slate-950 py-3 px-4 text-sm font-bold shadow-sm
              hover:bg-red-500 hover:text-white transition-colors focus:outline-none
              focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
          Cancelar
        </a>
      </div>

      <!-- Script de fechas y c치lculo total -->
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const fechaInicioEl = document.getElementById('fechaInicio');
          const fechaFinEl = document.getElementById('fechaFin');
          const totalEl = document.getElementById('total');
          const precioPorNocheEl = document.getElementById('precio');
          const fechaRealizadoEl = document.getElementById('fechaRealizado');
          const fechaRealizadoTextoEl = document.getElementById('fechaRealizadoTexto');

          // Fecha y hora actual
          const ahora = new Date();
          const offset = ahora.getTimezoneOffset();
          const localISOTime = new Date(ahora.getTime() - offset * 60000)
            .toISOString()
            .slice(0, 16);

          fechaRealizadoEl.value = localISOTime;

          const fechaMostrar = new Date(localISOTime).toLocaleString('es-ES', {
            dateStyle: 'short',
            timeStyle: 'short'
          });
          fechaRealizadoTextoEl.textContent = fechaMostrar;

          // Calcular total
          const calcularTotal = () => {
            const fechaInicio = new Date(fechaInicioEl.value);
            const fechaFin = new Date(fechaFinEl.value);
            const precio = parseFloat(precioPorNocheEl.value);

            if (fechaInicioEl.value && fechaFinEl.value && fechaFin > fechaInicio && !isNaN(precio)) {
              const diffTiempo = fechaFin.getTime() - fechaInicio.getTime();
              const diffDias = Math.ceil(diffTiempo / (1000 * 3600 * 24));
              const totalCalculado = diffDias * precio;
              totalEl.value = totalCalculado.toFixed(2);
            } else {
              totalEl.value = '0.00';
            }
          };

          fechaInicioEl.addEventListener('change', calcularTotal);
          fechaFinEl.addEventListener('change', calcularTotal);
        });
      </script>

    </form>
  </div>
</div>
</html>