<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layouts/_mainLayout">

<div layout:fragment="content" class="flex-grow bg-[var(--background-color)] items-center">
    <div class="mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8">
        <div class="space-y-12">
            <header>
                <h1 class="text-4xl font-extrabold tracking-tight text-[var(--text-primary)]">Editar Hotel</h1>
                <p class="mt-2 text-lg text-[var(--text-secondary)]">Actualiza la información del hotel</p>
            </header>
            <div>
                <form th:action="@{/hotel/save}" th:object="${hotelForm}" class="space-y-12 md:col-span-2" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="authCheck" value="authEdit">
                    <input type="hidden" th:field="*{id}" />

                    <!-- Información básica -->
                    <section class="space-y-6 rounded-2xl border border-[var(--border-color)] bg-white p-6 shadow-sm">
                        <h3 class="text-xl font-bold">Información Básica</h3>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div class="flex flex-col">
                                <label class="text-sm font-medium">Nombre del Hotel</label>
                                <input th:field="*{nombre}" type="text" class="form-input rounded-xl" th:errorclass="border-red-500"/>
                                <span th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="text-red-500"></span>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium">Dirección</label>
                                <input th:field="*{direccion}" type="text" class="form-input rounded-xl" th:errorclass="border-red-500"/>
                                <span th:if="${#fields.hasErrors('direccion')}" th:errors="*{direccion}" class="text-red-500"></span>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium">Descripción</label>
                                <textarea th:field="*{descripcion}" class="form-textarea rounded-xl" rows="3" th:errorclass="border-red-500"></textarea>
                                <span th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}" class="text-red-500"></span>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-sm font-medium">Zona</label>
                                <select th:field="*{idZona}" class="form-select rounded-xl" th:errorclass="border-red-500">
                                    <option value="">Seleccione una zona</option>
                                    <option th:each="zona : ${zonas}" th:value="${zona.id}" th:text="${zona.nombre}"></option>
                                </select>
                                <span th:if="${#fields.hasErrors('idZona')}" th:errors="*{idZona}" class="text-red-500"></span>
                            </div>
                        </div>
                    </section>

                    <!-- Tipos de Habitación -->
                    <section class="space-y-6 rounded-2xl border border-[var(--border-color)] bg-white p-6 shadow-sm">
                        <h3 class="text-xl font-bold">Tipos de Habitación</h3>
                        
                        <!-- Tipos de habitación existentes -->
                        <div id="room-types-container">
                            <div th:each="tipo, stat : *{tiposHabitacion}" class="room-type-block relative rounded-lg border border-gray-200 p-4 pt-8 mt-8">
                                <input type="hidden" th:field="*{tiposHabitacion[__${stat.index}__].id}" />
                                <input type="hidden" th:field="*{tiposHabitacion[__${stat.index}__].idHotel}" />
                                
                                <button type="button" class="remove-room-type-btn absolute top-2 right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-100 text-red-600 hover:bg-red-200"
                                        th:attr="data-room-type-id=${tipo.id}"
                                        onclick="markRoomTypeForDeletion(this)">
                                    &times;
                                </button>

                                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                    <div class="flex flex-col">
                                        <label class="text-sm font-medium">Nombre</label>
                                        <input th:field="*{tiposHabitacion[__${stat.index}__].nombre}" type="text" class="form-input rounded-xl"/>
                                        <span th:if="${#fields.hasErrors('tiposHabitacion[__${stat.index}__].nombre')}" 
                                              th:errors="*{tiposHabitacion[__${stat.index}__].nombre}" 
                                              class="text-red-500"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-sm font-medium">Cantidad de Personas</label>
                                        <input th:field="*{tiposHabitacion[__${stat.index}__].cantPersonas}" type="number" class="form-input rounded-xl"/>
                                        <span th:if="${#fields.hasErrors('tiposHabitacion[__${stat.index}__].cantPersonas')}" 
                                              th:errors="*{tiposHabitacion[__${stat.index}__].cantPersonas}" 
                                              class="text-red-500"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-sm font-medium">Cantidad de Habitaciones</label>
                                        <input th:field="*{tiposHabitacion[__${stat.index}__].cantHab}" type="number" class="form-input rounded-xl"/>
                                        <span th:if="${#fields.hasErrors('tiposHabitacion[__${stat.index}__].cantHab')}" 
                                              th:errors="*{tiposHabitacion[__${stat.index}__].cantHab}" 
                                              class="text-red-500"></span>
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-sm font-medium">Costo</label>
                                        <input th:field="*{tiposHabitacion[__${stat.index}__].costo}" type="number" step="0.01" class="form-input rounded-xl"/>
                                        <span th:if="${#fields.hasErrors('tiposHabitacion[__${stat.index}__].costo')}" 
                                              th:errors="*{tiposHabitacion[__${stat.index}__].costo}" 
                                              class="text-red-500"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="add-room-type-btn" type="button" class="flex items-center gap-2 rounded-full bg-[var(--secondary-color)] px-5 py-2.5 text-sm font-bold text-[var(--text-primary)] hover:bg-[var(--border-color)]">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Agregar Tipo de Habitación
                        </button>
                        
                        <!-- Campo oculto para IDs de tipos de habitación a eliminar -->
                        <input type="hidden" name="idsTiposHabitacionParaEliminar" id="idsTiposHabitacionParaEliminar" />
                    </section>

                    <!-- Imágenes -->
                    <section class="space-y-6 rounded-2xl border border-[var(--border-color)] bg-white p-6 shadow-sm">
                        <h3 class="text-xl font-bold">Imágenes</h3>
                        
                        <!-- Imágenes existentes -->
                        <div class="grid grid-cols-4 gap-4" id="existing-images">
                            <div th:each="imagen : *{imagenes}" class="relative">
                                <img th:src="@{'data:image/jpeg;base64,' + ${T(java.util.Base64).getEncoder().encodeToString(imagen.imagen)}}"
                                     class="h-32 w-32 rounded-xl object-cover"/>
                                <button type="button" 
                                        th:attr="data-image-id=${imagen.id}"
                                        onclick="markImageForDeletion(this)"
                                        class="absolute top-1 right-1 flex h-6 w-6 items-center justify-center rounded-full bg-red-600 text-white hover:bg-red-700">
                                    &times;
                                </button>
                            </div>
                        </div>

                        <!-- Nuevas imágenes -->
                        <div class="mt-4 grid grid-cols-4 gap-4" id="image-preview-container">
                            <label id="add-new-button-container" for="file-input-0" class="flex h-32 w-32 cursor-pointer flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-center hover:bg-gray-100">
                                <svg class="h-10 w-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
                                </svg>
                                <span class="text-sm font-medium text-gray-500">Añadir foto</span>
                                <input type="file" id="file-input-0" name="images" accept="image/*" class="hidden" onchange="handleImageUpload(event)"/>
                            </label>
                        </div>

                        <!-- Campo oculto para IDs de imágenes a eliminar -->
                        <input type="hidden" name="idsImagenesParaEliminar" id="idsImagenesParaEliminar" />
                    </section>

                    <div class="flex justify-end space-x-4">
                        <button type="submit" class="rounded-full bg-[var(--primary-color)] px-6 py-3 text-white">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // Script para marcar tipos de habitación para eliminación
        let roomTypesToDelete = [];
        function markRoomTypeForDeletion(button) {
            const roomTypeId = button.getAttribute('data-room-type-id');
            if (roomTypeId) {
                roomTypesToDelete.push(roomTypeId);
                document.getElementById('idsTiposHabitacionParaEliminar').value = roomTypesToDelete.join(',');
            }
            button.closest('.room-type-block').remove();
        }

        // Script para marcar imágenes para eliminación
        let imagesToDelete = [];
        function markImageForDeletion(button) {
            const imageId = button.getAttribute('data-image-id');
            if (imageId) {
                imagesToDelete.push(imageId);
                document.getElementById('idsImagenesParaEliminar').value = imagesToDelete.join(',');
            }
            button.closest('.relative').remove();
        }

        // Variable para llevar la cuenta de los inputs de archivo
        let fileInputCounter = 0;

        function handleImageUpload(event) {
            const input = event.target;
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const previewContainer = document.getElementById('image-preview-container');
            const newButtonContainer = document.getElementById('add-new-button-container');

            // 1. Crear la vista previa de la imagen
            const reader = new FileReader();
            reader.onload = function(e) {
                // Contenedor para la imagen y el botón de eliminar
                const imageWrapper = document.createElement('div');
                imageWrapper.classList.add('relative', 'h-32', 'w-32');

                // La imagen de previsualización
                const img = document.createElement('img');
                img.src = e.target.result;
                img.classList.add('h-full', 'w-full', 'rounded-xl', 'object-cover');
                imageWrapper.appendChild(img);

                // Botón para eliminar la imagen
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '&times;';
                deleteButton.classList.add('absolute', 'top-1', 'right-1', 'flex', 'h-6', 'w-6', 'items-center', 'justify-center', 'rounded-full', 'bg-red-600', 'text-white', 'font-bold', 'text-lg', 'hover:bg-red-700');
                deleteButton.onclick = function() {
                    imageWrapper.remove();
                    input.remove();
                };
                imageWrapper.appendChild(deleteButton);

                // Añadir la vista previa al contenedor
                previewContainer.insertBefore(imageWrapper, newButtonContainer);
            };
            reader.readAsDataURL(file);

            // 2. Ocultar el label del input que acabamos de usar
            const label = input.parentElement;
            label.style.display = 'none';

            // 3. Crear y añadir dinámicamente un nuevo botón de subida
            fileInputCounter++;
            const newFileInputId = `file-input-${fileInputCounter}`;

            const newLabel = document.createElement('label');
            newLabel.setAttribute('for', newFileInputId);
            newLabel.className = 'flex h-32 w-32 cursor-pointer flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 text-center hover:bg-gray-100';
            newLabel.id = 'add-new-button-container';

            newLabel.innerHTML = `
                <svg class="h-10 w-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                <span class="text-sm font-medium text-gray-500">Añadir foto</span>
                <input type="file" id="${newFileInputId}" name="images" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
            `;

            previewContainer.appendChild(newLabel);
        }

        // Script para añadir nuevos tipos de habitación
        document.addEventListener('DOMContentLoaded', function() {
            const addRoomBtn = document.getElementById('add-room-type-btn');
            const container = document.getElementById('room-types-container');
            let roomTypeIndex = /*[[${hotelForm.tiposHabitacion.size()}]]*/ 0;

            addRoomBtn.addEventListener('click', function() {
                const newRoomTypeBlock = document.createElement('div');
                newRoomTypeBlock.classList.add('room-type-block', 'relative', 'rounded-lg', 'border', 'border-gray-200', 'p-4', 'pt-8', 'mt-8');

                const blockHTML = `
                    <button type="button" class="remove-room-type-btn absolute top-2 right-2 flex h-6 w-6 items-center justify-center rounded-full bg-red-100 text-red-600 hover:bg-red-200">&times;</button>
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div class="flex flex-col">
                            <label class="text-sm font-medium">Nombre</label>
                            <input name="tiposHabitacion[${roomTypeIndex}].nombre" type="text" class="form-input rounded-xl"/>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium">Cantidad de Personas</label>
                            <input name="tiposHabitacion[${roomTypeIndex}].cantPersonas" type="number" class="form-input rounded-xl"/>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium">Cantidad de Habitaciones</label>
                            <input name="tiposHabitacion[${roomTypeIndex}].cantHab" type="number" class="form-input rounded-xl"/>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-sm font-medium">Costo</label>
                            <input name="tiposHabitacion[${roomTypeIndex}].costo" type="number" step="0.01" class="form-input rounded-xl"/>
                        </div>
                    </div>
                `;

                newRoomTypeBlock.innerHTML = blockHTML;
                container.appendChild(newRoomTypeBlock);

                // Añadir manejador para el botón de eliminar
                newRoomTypeBlock.querySelector('.remove-room-type-btn').addEventListener('click', function() {
                    newRoomTypeBlock.remove();
                });

                roomTypeIndex++;
            });
        });
    </script>
</div>
</html>
